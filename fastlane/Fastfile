# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do

  desc "Unit tests"
  lane :tests do |options|
      xcversion(version: "~> 12.4")
      fetched_sim = sh("xcrun simctl list | grep 'Fastlane' | cat")
      if !fetched_sim.empty?
          sh("xcrun", "simctl", "delete", "iPhone Fastlane")
      end
      sh("xcrun","simctl","create","iPhone Fastlane", "com.apple.CoreSimulator.SimDeviceType.iPhone-7","com.apple.CoreSimulator.SimRuntime.iOS-13-7")
      scan(
        clean: true,
        output_directory: './artifacts/unit-tests',
        scheme: 'CITestingTests',
        device: 'iPhone Fastlane',
        code_coverage: true,
        output_types: 'json-compilation-database,html,junit',
        output_files: 'compile_commands.json,report.html,report.junit')
  end
end

